# `syuttaikin_bot` モジュール 開発ルールと修正履歴

## 概要

`syuttaikin_bot`モジュールの開発過程で、主に**ファイルの配置ミス**、**命名の不整合**、**ロジックの重複**に起因する複数の問題が特定・修正されました。
このドキュメントは、再発防止と今後の開発効率化のため、その原因と解決策をルールとしてまとめたものです。

---

## 1. ファイル構造と命名規則 (最重要)

> **エラーの根本原因**: ボット全体の `interactionLoader.js` が特定のディレクトリ構造を前提としていることを理解していなかった。

### ルール1-1: インタラクションハンドラは指定のフォルダに配置する
- **問題**: `components/settings/buttons` のような深い階層に置かれたボタンやセレクトメニューのハンドラが読み込まれず、コンポーネントが反応しなかった。
- **原因**: `interactionLoader.js` は、各モジュールの `components` フォルダ直下にある `buttons`, `selects`, `modals` フォルダしか探索しないため。
- **対応策**: `components/settings` や `tasks` に散らばっていたハンドラファイルを、`interactionLoader` が読み込める `components/buttons` や `components/selects` に移動・集約した。
- **ルール**:
  - ボタンの処理ファイルは `syuttaikin_bot/components/buttons/` に配置する。
  - セレクトメニューの処理ファイルは `syuttaikin_bot/components/selects/` に配置する。
  - モーダルの処理ファイルは `syuttaikin_bot/components/modals/` に配置する。

### ルール1-2: 共通処理は `utils` に分離する
- **問題**: 設定パネルの更新処理 (`_updateSettingsMessage.js`) など、複数のハンドラで使われるロジックが `components` 内に点在し、見通しが悪かった。
- **対応策**: 複数のハンドラから呼び出される共通処理を `utils/` ディレクトリに移動させ、ファイル名のアンダースコアを削除して役割を明確化した。
- **ルール**: 複数の場所から呼び出される共通関数やヘルパー関数は、`syuttaikin_bot/utils/` ディレクトリに配置し、役割を明確にする。

### ルール1-3: ファイル名は正確に参照する
- **問題**: `syuttaikinStateManager.js` が、多くのファイルで `syuttaikiStateManager.js` (`n`が欠落) とタイプミスされており、`Cannot find module` エラーが多発した。
- **対応策**: プロジェクト全体を検索し、`syuttaikiStateManager.js` への誤った参照をすべて `syuttaikinStateManager.js` に修正した。
- **ルール**: ファイルを `require` する際は、ファイル名とパスが正確であることを必ず確認する。

---

## 2. コードの品質と一貫性

### ルール2-1: 不要・重複したコードは削除する
- **問題**: `castShiftSettingComponents.js` のように、実際には使われていない古いコンポーネント定義ファイルが残っており、`updateSettingsMessage.js` で定義されたUIと機能が重複していた。
- **対応策**: 実際には使われておらず、`updateSettingsMessage.js` と機能が重複していた `castShiftSettingComponents.js` を削除し、UI関連のロジックを一本化した。
- **ルール**: 機能が重複していたり、どこからも参照されていない古いコードは、混乱を避けるために積極的に削除する。

### ルール2-2: ロジックを共通化し、重複を避ける
- **問題**: 当初、「時間削除」機能は出勤用と退勤用で個別のロジックが書かれようとしており、実装に不整合があった。
- **対応策**: 出勤時間と退勤時間の削除処理を、共通関数 `utils/handleRemoveTimeSelect.js` に集約し、各ハンドラからはこの関数を呼び出すように修正した。
- **ルール**: 似たような処理は共通の関数（例: `handleRemoveTimeSelect`）にまとめ、それを各ハンドラから呼び出す形式にする。これにより、修正が容易になり、バグの発生も抑制できる。