# okuribito_bot 開発ルール

このドキュメントは、開発中に発生したエラーや問題から学んだルールをまとめたものです。
新しい機能を追加・修正する際は、ここに記載されたルールに従ってください。

---

## 1. ファイル構造 (最重要)

> **エラーの原因のほとんどは、ファイルが間違った場所に置かれていることでした。**

### 1-1. コマンドファイル
*   **ルール:** スラッシュコマンド (`/`で始まるコマンド) を定義するファイルは、必ず `okuribito_bot/commands/` ディレクトリ配下に配置してください。
*   **理由:** `index.js` の `commandLoader` は、このディレクトリのみを探索してコマンドを自動登録します。ルートディレクトリなどに置かれたファイルは**絶対に認識されません。**

### 1-2. インタラクションファイル
*   **ルール:** ボタン、セレクトメニュー、モーダルなどのインタラクションを処理するファイルは、`okuribito_bot/components/` ディレクトリ配下の、対応するフォルダ (`buttons`, `selects`, `modals`) に配置してください。
*   **理由:** `interactionLoader` がこの構造を前提としており、正しい場所に配置しないとハンドラとして登録されず、コンポーネントを操作しても無反応になります。

### 1-3. ルートディレクトリのクリーンアップ
*   **ルール:** プロジェクトのルートディレクトリ (`E:\🌳星の校庭🌳\`) には、ボットのロジックを記述する `.js` ファイルを**絶対に置かないでください。**
*   **理由:** ファイルの役割が不明確になり、混乱や意図しない動作の原因となります。古いファイルはためらわずに削除してください。

---

## 2. インタラクション処理

### 2-1. `customId` の命名と一致
*   **ルール:** インタラクションファイルの `module.exports` 内で定義する `customId` は、コンポーネントを作成する際の `setCustomId()` の値と**完全に一致**させる必要があります。
*   **例:** `new ButtonBuilder().setCustomId('okuribito_config_role')` に対応するファイルは `module.exports = { customId: 'okuribito_config_role', ... }` となります。
*   **注意:** このIDが一致しないと、ボタンを押しても「このインタラクションは失敗しました」というエラーが発生します。

### 2-2. 動的な `customId` の扱い
*   **ルール:** `messageId` などの可変な情報を含む `customId` (例: `okuribito_note_modal:${messageId}`) を扱う場合、`interactionCreate` イベントリスナー側で `interaction.customId.startsWith('okuribito_note_modal')` のように前方一致でハンドラを特定してください。
*   **理由:** これにより、どのメッセージに属するインタラクションかを判別できます。

### 2-3. 応答の基本パターン
*   **ルール:** インタラクションの応答は、原則として `await interaction.deferReply({ ephemeral: true });` または `await interaction.deferUpdate();` で開始し、後続の処理は `await interaction.editReply(...)` や `await interaction.followUp(...)` で行うことを推奨します。
*   **理由:** 3秒以上かかる可能性のある処理（GCSへのアクセスなど）でのタイムアウトエラーを防ぎます。また、`ephemeral` の非推奨警告を回避するモダンな書き方です。

---

## 3. 設定とデータ管理

### 3-1. 設定の一元化
*   **ルール:** GCSのバケット名やファイルパスなど、複数の場所で利用する可能性のある設定値は、`okuribitoConfigManager.js` のような専用の管理ファイルに一元化してください。
*   **理由:** 設定の変更が容易になり、各コンポーネントのコードがシンプルになります。ハードコーディングは避けてください。

### 3-2. 設定の安全な更新
*   **ルール:** 既存の設定ファイルに項目を追加・更新する場合、必ず `const currentConfig = await loadOkuribitoConfig(guildId) || {};` のように既存の設定を読み込み、`const newConfig = { ...currentConfig, okuribitoRoleId: roleId };` のようにスプレッド構文でマージしてください。
*   **理由:** 直接新しいオブジェクトで保存すると、ファイル内の他の設定（シフト情報など）がすべて消えてしまいます。

---

## 4. ロギング

### 4-1. ログ出力の統一
*   **ルール:** デバッグや情報表示のためのコンソール出力には、`console.log` ではなく、プロジェクト共通の `logger` (`utils/logger.js`) を使用してください。
*   **理由:** ログのフォーマットが統一され、管理がしやすくなります。

### 4-2. 操作ログの記録
*   **ルール:** ユーザーによる設定変更などの操作記録は、`logToThread` (`utils/okuribitoLogger.js`) を使用して、指定されたスレッドにEmbed形式で記録してください。
*   **理由:** 誰がいつ何をしたのかをDiscord上で追跡できるようにするためです。

